<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Making Your Code Robust</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="style.css" rel="stylesheet" type="text/css">
<link rel="icon" href="../favicon.ico" type="image/x-icon" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<link href="$relpath/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="$relpath/search.js"></script>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<div style="padding:10px">
<table border="0" bgcolor="#FFFFFF" cellspacing="5" width="100%">
 <tr>
  <td width="24px" rowspan="2"><img src="../logo.png" alt="Logo" /></td>
  <td><font family="Arial" size="+2">crashrpt</font></td>
  <td rowspan="2" align="right"></td>
 </tr>
 <tr>
  <td colspan="2"><span style="font-size:0.9em"><i>A crash reporting system for Windows applications</i></a></td>
 </tr>
</table>
</div>
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">CrashRpt Documentation</a></li><li class="navelem"><a class="el" href="other_topics.html">Other Topics</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Making Your Code Robust </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This page contains some tips on writing C++ code robust to errors. A program that conforms to these rules is less likely to crash.</p>
<p>This page contains the following topics:</p>
<ul>
<li><a class="el" href="writing_robust_code.html#coding_guide_intro">Introduction</a></li>
<li><a class="el" href="writing_robust_code.html#init_vars">Initializing Local Variables</a></li>
<li><a class="el" href="writing_robust_code.html#init_winapi_structures">Initializing WinAPI Structures</a></li>
<li><a class="el" href="writing_robust_code.html#validate_input">Validating Function Input</a></li>
<li><a class="el" href="writing_robust_code.html#validate_pointers">Validating Pointers</a></li>
<li><a class="el" href="writing_robust_code.html#init_func_output">Initializing Function Output</a></li>
<li><a class="el" href="writing_robust_code.html#clean_up_pointers">Cleaning Up Pointers to Deleted Objects</a></li>
<li><a class="el" href="writing_robust_code.html#clean_up_handles">Cleaning Up Released Handles</a></li>
<li><a class="el" href="writing_robust_code.html#delete_operator">Using delete [] Operator for Arrays</a></li>
<li><a class="el" href="writing_robust_code.html#allocate_memory_carefully">Allocating Memory Carefully</a></li>
<li><a class="el" href="writing_robust_code.html#use_asserts_carefully">Using Asserts Carefully</a></li>
<li><a class="el" href="writing_robust_code.html#check_return_code">Checking Return Code of a Function</a></li>
<li><a class="el" href="writing_robust_code.html#use_smart_ptrs">Using Smart Pointers</a></li>
<li><a class="el" href="writing_robust_code.html#equality_operator">Using == Operator Carefully</a></li>
</ul>
<h1><a class="anchor" id="coding_guide_intro"></a>
Introduction</h1>
<p>As a program grows in size and dependencies, you start losing trace of its components, get further away from the big picture, and ease the introduction of bugs [<a href="http://www.iovene.com/28/">How to write robust code</a>]. So it is important to realise that some rules should be followed to write a code more tolerant to errors.</p>
<p>Generally speaking, robust code has such features as: it is well designed, neat and tidy, well named, well commented, well tested, it rarely crashes.</p>
<p>If your program follows consistent coding rules (for example, <a href="http://geosoft.no/development/cppstyle.html">C++ Programming Style Guidelines</a>, <a href="http://www.doc.ic.ac.uk/lab/cplus/c%2b%2b.rules/chap4.html#sect2">Programming in C++, Rules and Recommendations</a> or <a href="http://google-styleguide.googlecode.com/svn/trunk/cppguide.xml">Google C++ Style Guide</a>) it is less likely to crash, because it has a consistent structure.</p>
<p>Even if your program currently doesn't follow any coding rules because of its complexity and because of your team structure, following the simple rules listed below may help you to avoid the majority of the crash situations.</p>
<h1><a class="anchor" id="init_vars"></a>
Initializing Local Variables</h1>
<p>Not ininitialized local variables are a common reason of program crashes. For example, see the following code fragment:</p>
<div class="fragment"><div class="line"><span class="comment">// Define local variables</span></div><div class="line"></div><div class="line">BOOL bExitResult; <span class="comment">// This will be TRUE if the function exits successfully</span></div><div class="line">FILE* f; <span class="comment">// Handle to file</span></div><div class="line">TCHAR szBuffer[_MAX_PATH];   <span class="comment">// String buffer</span></div><div class="line">  </div><div class="line"><span class="comment">// Do something with variables above...</span></div></div><!-- fragment --><p>The code fragment above can be a potential reason of a crash, because none of local variables is initialized. The correct code would be the following:</p>
<div class="fragment"><div class="line"><span class="comment">// Define local variables</span></div><div class="line"></div><div class="line"><span class="comment">// Initialize function exit code with FALSE to indicate failure assumption</span></div><div class="line">BOOL bExitResult = FALSE; <span class="comment">// This will be TRUE if the function exits successfully</span></div><div class="line"></div><div class="line"><span class="comment">// Initialize file handle with NULL</span></div><div class="line">FILE* f = NULL; <span class="comment">// Handle to file</span></div><div class="line"></div><div class="line"><span class="comment">// Initialize string buffer with empty string</span></div><div class="line">TCHAR szBuffer[_MAX_PATH] = _T(<span class="stringliteral">&quot;&quot;</span>);   <span class="comment">// String buffer</span></div><div class="line"></div><div class="line"><span class="comment">// Do something with variables above...</span></div></div><!-- fragment --><h1><a class="anchor" id="init_winapi_structures"></a>
Initializing WinAPI Structures</h1>
<p>Many WinAPI functions receive/return parameters through C structures. Such a structure, if incorrectly initialized, may be the reason of a crash.</p>
<p>It is recommended to use <b>ZeroMemory()</b> or <b>memset()</b> to fill the structure with zeroes (this typically sets structure fields to their default values).</p>
<p>Many WinAPI structures also have the <b>cbSize</b> parameter that must be initialized with the size of the structure before using.</p>
<p>The following code shows how to initialize a WinAPI structure:</p>
<div class="fragment"><div class="line">NOTIFYICONDATA nf;</div><div class="line">memset(&amp;nf,0,<span class="keyword">sizeof</span>(NOTIFYICONDATA)); <span class="comment">// Zero memory</span></div><div class="line">nf.cbSize = <span class="keyword">sizeof</span>(NOTIFYICONDATA); <span class="comment">// Set structure size!</span></div><div class="line"><span class="comment">// Initialize other structure members</span></div><div class="line">nf.hWnd = hWndParent;</div><div class="line">nf.uID = 0;   </div><div class="line">nf.uFlags = NIF_ICON | NIF_TIP;</div><div class="line">nf.hIcon = ::LoadIcon(NULL, IDI_APPLICATION);</div><div class="line">_tcscpy_s(nf.szTip, 128, _T(<span class="stringliteral">&quot;Popup Tip Text&quot;</span>));</div><div class="line">      </div><div class="line"><span class="comment">// Add a tray icon</span></div><div class="line">Shell_NotifyIcon(NIM_ADD, &amp;nf);</div></div><!-- fragment --><p>But! DO NOT use <b>ZeroMemory()</b> or <b>memset()</b> for your C++ structures that contain objects as structure members, that may corrupt their internal state and be the reason of a crash.</p>
<div class="fragment"><div class="line"><span class="comment">// Declare a C++ structure</span></div><div class="line"><span class="keyword">struct </span>ItemInfo</div><div class="line">{</div><div class="line">  std::string sItemName; <span class="comment">// The structure has std::string object inside</span></div><div class="line">  <span class="keywordtype">int</span> nItemValue;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">// Init the structure</span></div><div class="line">ItemInfo item;</div><div class="line"></div><div class="line"><span class="comment">// Do not use memset()! It can corrupt the structure</span></div><div class="line"><span class="comment">// memset(&amp;item, 0, sizeof(ItemInfo));</span></div><div class="line"></div><div class="line"><span class="comment">// Instead use the following</span></div><div class="line">item.sItemName = <span class="stringliteral">&quot;item1&quot;</span>;</div><div class="line">item.nItemValue = 0;          </div></div><!-- fragment --><p>It is even better to use a constructor for your C++ structure that would init its members with default values:</p>
<div class="fragment"><div class="line"><span class="comment">// Declare a C++ structure</span></div><div class="line"><span class="keyword">struct </span>ItemInfo</div><div class="line">{</div><div class="line">  <span class="comment">// Use structure constructor to set members with default values</span></div><div class="line">  ItemInfo()</div><div class="line">  {</div><div class="line">    sItemName = _T(<span class="stringliteral">&quot;unknown&quot;</span>);</div><div class="line">    nItemValue = -1;</div><div class="line">  }</div><div class="line">      </div><div class="line">  std::string sItemName; <span class="comment">// The structure has std::string object inside</span></div><div class="line">  <span class="keywordtype">int</span> nItemValue;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">// Init the structure</span></div><div class="line">ItemInfo item;</div><div class="line"></div><div class="line"><span class="comment">// Do not use memset()! It can corrupt the structure</span></div><div class="line"><span class="comment">// memset(&amp;item, 0, sizeof(ItemInfo));</span></div><div class="line"></div><div class="line"><span class="comment">// Instead use the following</span></div><div class="line">item.sItemName = <span class="stringliteral">&quot;item1&quot;</span>;</div><div class="line">item.nItemValue = 0;          </div></div><!-- fragment --><h1><a class="anchor" id="validate_input"></a>
Validating Function Input</h1>
<p>It is recommended to always validate function input parameters.</p>
<div class="fragment"><div class="line">BOOL DrawVehicle(HWND hWnd, LPRECT prcDraw, <span class="keywordtype">int</span> nDrawingQuality)</div><div class="line">{</div><div class="line">  <span class="comment">// Check that window is valid</span></div><div class="line">  <span class="keywordflow">if</span>(!IsWindow(hWnd))</div><div class="line">    <span class="keywordflow">return</span> FALSE;</div><div class="line"></div><div class="line">  <span class="comment">// Check that drawing rect is valid</span></div><div class="line">  <span class="keywordflow">if</span>(prcDraw==NULL)</div><div class="line">    <span class="keywordflow">return</span> FALSE;</div><div class="line"></div><div class="line">  <span class="comment">// Check drawing quality is valid</span></div><div class="line">  <span class="keywordflow">if</span>(nDrawingQuality&lt;0 || nDrawingQuality&gt;100)</div><div class="line">    <span class="keywordflow">return</span> FALSE;</div><div class="line"> </div><div class="line">  <span class="comment">// Now it&#39;s safe to draw the vehicle</span></div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> TRUE;</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="validate_pointers"></a>
Validating Pointers</h1>
<p>If you use a pointer, make sure it is not equal to NULL.</p>
<div class="fragment"><div class="line">CVehicle* pVehicle = GetCurrentVehicle();</div><div class="line"></div><div class="line"><span class="comment">// Validate pointer</span></div><div class="line"><span class="keywordflow">if</span>(pVehicle==NULL)</div><div class="line">{</div><div class="line">  <span class="comment">// Invalid pointer, do not use it!</span></div><div class="line">  <span class="keywordflow">return</span> FALSE;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// Use the pointer</span></div></div><!-- fragment --><h1><a class="anchor" id="init_func_output"></a>
Initializing Function Output</h1>
<p>If your function creates an object and returns it as a function parameter, it is recommended to initialize the pointer with NULL in the beginning of the function body.</p>
<p>If you do not explicitly initialize the output parameter and further it is not set due to a bug in function logics, the caller may use invalid pointer which would possibly cause a crash.</p>
<p>Example of incorrect code:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> CreateVehicle(CVehicle** ppVehicle)</div><div class="line">{</div><div class="line">  <span class="keywordflow">if</span>(CanCreateVehicle())</div><div class="line">  {</div><div class="line">    *ppVehicle = <span class="keyword">new</span> CVehicle();</div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">  }    </div><div class="line"></div><div class="line">  <span class="comment">// If CanCreateVehicle() returns FALSE,</span></div><div class="line">  <span class="comment">// the pointer to *ppVehcile would never be set!</span></div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>The correct code:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> CreateVehicle(CVehicle** ppVehicle)</div><div class="line">{</div><div class="line">  <span class="comment">// First initialize the output parameter with NULL</span></div><div class="line">  *ppVehicle = NULL;</div><div class="line"></div><div class="line">  <span class="keywordflow">if</span>(CanCreateVehicle())</div><div class="line">  {</div><div class="line">    *ppVehicle = <span class="keyword">new</span> CVehicle();</div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">  }    </div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="clean_up_pointers"></a>
Cleaning Up Pointers to Deleted Objects</h1>
<p>Assign NULL to a pointer after freeing (or deleting) it. This will help to ensure noone will try to reuse an invalid pointer.</p>
<div class="fragment"><div class="line"><span class="comment">// Create object</span></div><div class="line">CVehicle* pVehicle = <span class="keyword">new</span> CVehicle();</div><div class="line"></div><div class="line"><span class="keyword">delete</span> pVehicle; <span class="comment">// Free pointer</span></div><div class="line">pVehicle = NULL; <span class="comment">// Set pointer with NULL</span></div></div><!-- fragment --><h1><a class="anchor" id="clean_up_handles"></a>
Cleaning Up Released Handles</h1>
<p>Assign NULL (or zero, or something else default value) to a handle after freeing it. This will help to ensure noone will try to reuse an invalid handle.</p>
<p>Below is an example of how to clean up a WinAPI file handle. </p><div class="fragment"><div class="line">HANDLE hFile = INVALID_HANDLE_VALUE; </div><div class="line"></div><div class="line"><span class="comment">// Open file</span></div><div class="line">hFile = CreateFile(_T(<span class="stringliteral">&quot;example.dat&quot;</span>), FILE_READ|FILE_WRITE, FILE_OPEN_EXISTING);</div><div class="line"><span class="keywordflow">if</span>(hFile==INVALID_HANDLE_VALUE)</div><div class="line">{</div><div class="line">  <span class="keywordflow">return</span> FALSE; <span class="comment">// Error opening file</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// Do something with file</span></div><div class="line"></div><div class="line"><span class="comment">// Finally, close the handle</span></div><div class="line"><span class="keywordflow">if</span>(hFile!=INVALID_HANDLE_VALUE)</div><div class="line">{</div><div class="line">  CloseHandle(hFile);   <span class="comment">// Close handle to file</span></div><div class="line">  hFile = INVALID_HANDLE_VALUE;   <span class="comment">// Clean up handle</span></div><div class="line">}</div></div><!-- fragment --><p>Below is an example of how to clean up a FILE* handle. </p><div class="fragment"><div class="line"><span class="comment">// First init file handle pointer with NULL</span></div><div class="line">FILE* f = NULL;</div><div class="line"></div><div class="line"><span class="comment">// Open handle to file</span></div><div class="line">errno_t err = _tfopen_s(_T(<span class="stringliteral">&quot;example.dat&quot;</span>), _T(<span class="stringliteral">&quot;rb&quot;</span>));</div><div class="line"><span class="keywordflow">if</span>(err!=0 || f==NULL)</div><div class="line">  <span class="keywordflow">return</span> FALSE; <span class="comment">// Error opening file</span></div><div class="line"></div><div class="line"><span class="comment">// Do something with file</span></div><div class="line"></div><div class="line"><span class="comment">// When finished, close the handle</span></div><div class="line"><span class="keywordflow">if</span>(f!=NULL) <span class="comment">// Check that handle is valid</span></div><div class="line">{</div><div class="line">  fclose(f);</div><div class="line">  f = NULL; <span class="comment">// Clean up pointer to handle</span></div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="delete_operator"></a>
Using delete [] Operator for Arrays</h1>
<p>If you allocate a single object with the operator <b>new</b>, you should free it with the operator <b>delete</b>.</p>
<p>But if you allocate an array of objects with the operator <b>new</b>, you should free this array with <b> delete [] </b>.</p>
<div class="fragment"><div class="line"><span class="comment">// Create an array of objects</span></div><div class="line">CVehicle* paVehicles = <span class="keyword">new</span> CVehicle[10];</div><div class="line"></div><div class="line"><span class="keyword">delete</span> [] paVehicles; <span class="comment">// Free pointer to array</span></div><div class="line">paVehicles = NULL; <span class="comment">// Set pointer with NULL</span></div></div><!-- fragment --><p>or</p>
<div class="fragment"><div class="line"><span class="comment">// Create a buffer of bytes</span></div><div class="line">LPBYTE pBuffer = <span class="keyword">new</span> BYTE[255];</div><div class="line"></div><div class="line"><span class="keyword">delete</span> [] pBuffer; <span class="comment">// Free pointer to array</span></div><div class="line">pBuffer = NULL; <span class="comment">// Set pointer with NULL</span></div></div><!-- fragment --><h1><a class="anchor" id="allocate_memory_carefully"></a>
Allocating Memory Carefully</h1>
<p>Ensure that 0 (zero) bytes are not allocated using <b>malloc()</b> or <b>new</b>.</p>
<div class="fragment"><div class="line">UINT uBufferSize = GetBufferSize(); <span class="comment">// Determine what buffer to allocate.</span></div><div class="line"></div><div class="line">LPBYTE* pBuffer = NULL; <span class="comment">// Init pointer to buffer</span></div><div class="line"></div><div class="line"><span class="comment">// Allocate a buffer only if buffer size &gt; 0</span></div><div class="line"><span class="keywordflow">if</span>(uBufferSize!=0)</div><div class="line"> pBuffer = <span class="keyword">new</span> BYTE[uBufferSize];</div></div><!-- fragment --><p>For additional tips on how to allocate memory correctly, you can read the <a href="http://www.codeproject.com/KB/tips/CBP_for_memory_allocation.aspx">Secure Coding Best Practices for Memory Allocation in C and C++</a> article.</p>
<h1><a class="anchor" id="use_asserts_carefully"></a>
Using Asserts Carefully</h1>
<p>Asserts can be used in debug mode for checking preconditions and postconditions. But when you compile your program in release mode, asserts are removed on the preprocessing stage. So, using asserts is not enough to validate your program's state.</p>
<p>Incorrect code:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;assert.h&gt;</span></div><div class="line"></div><div class="line">CVehicle* ReadVehicleModelFromFile(LPCTSTR szFileName)</div><div class="line">{</div><div class="line">  CVehicle* pVehicle = NULL; <span class="comment">// Pointer to vehicle object</span></div><div class="line"></div><div class="line">  <span class="comment">// Check preconditions</span></div><div class="line">  assert(szFileName!=NULL); <span class="comment">// This will be removed by preprocessor in Release mode!</span></div><div class="line">  assert(_tcslen(szFileName)!=0); <span class="comment">// This will be removed by preprocessor in Release mode!</span></div><div class="line"></div><div class="line">  <span class="comment">// Open the file</span></div><div class="line">  FILE* f = _tfopen(szFileName, _T(<span class="stringliteral">&quot;rt&quot;</span>));</div><div class="line"></div><div class="line">  <span class="comment">// Create new CVehicle object</span></div><div class="line">  pVehicle = <span class="keyword">new</span> CVehicle();</div><div class="line"></div><div class="line">  <span class="comment">// Read vehicle model from file</span></div><div class="line"></div><div class="line">  <span class="comment">// Check postcondition </span></div><div class="line">  assert(pVehicle-&gt;GetWheelCount()==4); <span class="comment">// This will be removed by preprocessor in Release mode!</span></div><div class="line"></div><div class="line">  <span class="comment">// Return pointer to the vehicle object</span></div><div class="line">  <span class="keywordflow">return</span> pVehicle;</div><div class="line">}</div></div><!-- fragment --><p>As you can see in the code above, usage of asserts can help you to check your program state in Debug mode, but in Release mode these checks will just disappear.</p>
<p>The correct code would be:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;assert.h&gt;</span></div><div class="line"></div><div class="line">CVehicle* ReadVehicleModelFromFile(LPCTSTR szFileName, )</div><div class="line">{</div><div class="line">  CVehicle* pVehicle = NULL; <span class="comment">// Pointer to vehicle object</span></div><div class="line"></div><div class="line">  <span class="comment">// Check preconditions</span></div><div class="line">  assert(szFileName!=NULL); <span class="comment">// This will be removed by preprocessor in Release mode!</span></div><div class="line">  assert(_tcslen(szFileName)!=0); <span class="comment">// This will be removed by preprocessor in Release mode!</span></div><div class="line"></div><div class="line">  <span class="keywordflow">if</span>(szFileName==NULL || _tcslen(szFileName)==0)</div><div class="line">    <span class="keywordflow">return</span> NULL; <span class="comment">// Invalid input parameter</span></div><div class="line"></div><div class="line">  <span class="comment">// Open the file</span></div><div class="line">  FILE* f = _tfopen(szFileName, _T(<span class="stringliteral">&quot;rt&quot;</span>));</div><div class="line"></div><div class="line">  <span class="comment">// Create new CVehicle object</span></div><div class="line">  pVehicle = <span class="keyword">new</span> CVehicle();</div><div class="line"></div><div class="line">  <span class="comment">// Read vehicle model from file</span></div><div class="line"></div><div class="line">  <span class="comment">// Check postcondition </span></div><div class="line">  assert(pVehicle-&gt;GetWheelCount()==4); <span class="comment">// This will be removed by preprocessor in Release mode!</span></div><div class="line"></div><div class="line">  <span class="keywordflow">if</span>(pVehicle-&gt;GetWheelCount!=4)</div><div class="line">  { </div><div class="line">    <span class="comment">// Oops... an invalid wheel count was encountered!  </span></div><div class="line">    <span class="keyword">delete</span> pVehicle; </div><div class="line">    pVehicle = NULL;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// Return pointer to the vehicle object</span></div><div class="line">  <span class="keywordflow">return</span> pVehicle;</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="check_return_code"></a>
Checking Return Code of a Function</h1>
<p>It is a common mistake to call the function and assume it will succeed. When you call a function, it is recommended to check its return code and values of output parameters.</p>
<p>The following code calls functions in succession. Whether to proceed or to exit depends on return code and output parameters.</p>
<div class="fragment"><div class="line">HRESULT hres = E_FAIL;</div><div class="line">IWbemServices *pSvc = NULL;</div><div class="line">IWbemLocator *pLoc = NULL;</div><div class="line"></div><div class="line">hres =  CoInitializeSecurity(</div><div class="line">    NULL, </div><div class="line">    -1,                          <span class="comment">// COM authentication</span></div><div class="line">    NULL,                        <span class="comment">// Authentication services</span></div><div class="line">    NULL,                        <span class="comment">// Reserved</span></div><div class="line">    RPC_C_AUTHN_LEVEL_DEFAULT,   <span class="comment">// Default authentication </span></div><div class="line">    RPC_C_IMP_LEVEL_IMPERSONATE, <span class="comment">// Default Impersonation  </span></div><div class="line">    NULL,                        <span class="comment">// Authentication info</span></div><div class="line">    EOAC_NONE,                   <span class="comment">// Additional capabilities </span></div><div class="line">    NULL                         <span class="comment">// Reserved</span></div><div class="line">    );</div><div class="line"></div><div class="line">                  </div><div class="line"><span class="keywordflow">if</span> (FAILED(hres))</div><div class="line">{</div><div class="line">    log_write(_T(<span class="stringliteral">&quot;Failed to initialize security. Error code = %X\n&quot;</span>), hres);</div><div class="line">    <span class="keywordflow">if</span>(hres!=RPC_E_TOO_LATE) <span class="keywordflow">return</span> FALSE;</div><div class="line">}</div><div class="line"></div><div class="line">hres = CoCreateInstance(</div><div class="line">    CLSID_WbemLocator,             </div><div class="line">    0, </div><div class="line">    CLSCTX_INPROC_SERVER, </div><div class="line">    IID_IWbemLocator, (LPVOID *) &amp;pLoc);</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (FAILED(hres) || !pLoc)</div><div class="line">{</div><div class="line">    log_write(_T(<span class="stringliteral">&quot;Failed to create IWbemLocator object. Err code = %X&quot;</span>), hres);</div><div class="line">    <span class="keywordflow">return</span> FALSE;               </div><div class="line">}</div><div class="line"></div><div class="line">hres = pLoc-&gt;ConnectServer(</div><div class="line">     _bstr_t(L<span class="stringliteral">&quot;ROOT\\CIMV2&quot;</span>), <span class="comment">// Object path of WMI namespace</span></div><div class="line">     NULL,                    <span class="comment">// User name. NULL = current user</span></div><div class="line">     NULL,                    <span class="comment">// User password. NULL = current</span></div><div class="line">     0,                       <span class="comment">// Locale. NULL indicates current</span></div><div class="line">     NULL,                    <span class="comment">// Security flags.</span></div><div class="line">     0,                       <span class="comment">// Authority (e.g. Kerberos)</span></div><div class="line">     0,                       <span class="comment">// Context object </span></div><div class="line">     &amp;pSvc                    <span class="comment">// pointer to IWbemServices proxy</span></div><div class="line">     );</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (FAILED(hres) || !pSvc)</div><div class="line">{</div><div class="line">    log_write(_T(<span class="stringliteral">&quot;Couldn&#39;t conect server\n&quot;</span>));      </div><div class="line">    <span class="keywordflow">if</span>(pLoc) pLoc-&gt;Release();     </div><div class="line">    <span class="keywordflow">return</span> FALSE;  </div><div class="line">}</div><div class="line"></div><div class="line">hres = CoSetProxyBlanket(</div><div class="line">   pSvc,                        <span class="comment">// Indicates the proxy to set</span></div><div class="line">   RPC_C_AUTHN_WINNT,           <span class="comment">// RPC_C_AUTHN_xxx</span></div><div class="line">   RPC_C_AUTHZ_NONE,            <span class="comment">// RPC_C_AUTHZ_xxx</span></div><div class="line">   NULL,                        <span class="comment">// Server principal name </span></div><div class="line">   RPC_C_AUTHN_LEVEL_CALL,      <span class="comment">// RPC_C_AUTHN_LEVEL_xxx </span></div><div class="line">   RPC_C_IMP_LEVEL_IMPERSONATE, <span class="comment">// RPC_C_IMP_LEVEL_xxx</span></div><div class="line">   NULL,                        <span class="comment">// client identity</span></div><div class="line">   EOAC_NONE                    <span class="comment">// proxy capabilities </span></div><div class="line">);</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (FAILED(hres))</div><div class="line">{</div><div class="line">    log_write(_T(<span class="stringliteral">&quot;Could not set proxy blanket.\n&quot;</span>));</div><div class="line">    <span class="keywordflow">if</span>(pSvc) pSvc-&gt;Release();</div><div class="line">    <span class="keywordflow">if</span>(pLoc) pLoc-&gt;Release();     </div><div class="line">    <span class="keywordflow">return</span> FALSE;               </div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="use_smart_ptrs"></a>
Using Smart Pointers</h1>
<p>If you intensively use pointers to shared objects (e.g., COM interfaces), it is a good practice to wrap them into smart pointers. The smart pointer will take care of your object's reference counting and will protect you from accessing an object that was already deleted. That is, you don't need to worry about controlling the lifetime of your interface pointer.</p>
<p>For additional info on smart pointers, see the following articles: <a href="http://ootips.org/yonat/4dev/smart-pointers.html">Smart Pointers - What, Why, Which?</a> and <a href="http://www.codeproject.com/KB/cpp/SmartPointers.aspx">Implementing a Simple Smart Pointer in C++</a>.</p>
<p>Below is an example code (borrowed from MSDN) that uses ATL's <a href="http://msdn.microsoft.com/en-us/library/ezzw7k98(v=VS.100).aspx"><b>CComPtr</b></a> template class as a smart pointer.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;windows.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;shobjidl.h&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;atlbase.h&gt;</span> <span class="comment">// Contains the declaration of CComPtr.</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> WINAPI wWinMain(HINSTANCE hInstance, HINSTANCE, PWSTR pCmdLine, <span class="keywordtype">int</span> nCmdShow)</div><div class="line">{</div><div class="line">    HRESULT hr = CoInitializeEx(NULL, COINIT_APARTMENTTHREADED | </div><div class="line">        COINIT_DISABLE_OLE1DDE);</div><div class="line">    <span class="keywordflow">if</span> (SUCCEEDED(hr))</div><div class="line">    {</div><div class="line">        CComPtr&lt;IFileOpenDialog&gt; pFileOpen;</div><div class="line"></div><div class="line">        <span class="comment">// Create the FileOpenDialog object.</span></div><div class="line">        hr = pFileOpen.CoCreateInstance(__uuidof(FileOpenDialog));</div><div class="line">        <span class="keywordflow">if</span> (SUCCEEDED(hr))</div><div class="line">        {</div><div class="line">            <span class="comment">// Show the Open dialog box.</span></div><div class="line">            hr = pFileOpen-&gt;Show(NULL);</div><div class="line"></div><div class="line">            <span class="comment">// Get the file name from the dialog box.</span></div><div class="line">            <span class="keywordflow">if</span> (SUCCEEDED(hr))</div><div class="line">            {</div><div class="line">                CComPtr&lt;IShellItem&gt; pItem;</div><div class="line">                hr = pFileOpen-&gt;GetResult(&amp;pItem);</div><div class="line">                <span class="keywordflow">if</span> (SUCCEEDED(hr))</div><div class="line">                {</div><div class="line">                    PWSTR pszFilePath;</div><div class="line">                    hr = pItem-&gt;GetDisplayName(SIGDN_FILESYSPATH, &amp;pszFilePath);</div><div class="line"></div><div class="line">                    <span class="comment">// Display the file name to the user.</span></div><div class="line">                    <span class="keywordflow">if</span> (SUCCEEDED(hr))</div><div class="line">                    {</div><div class="line">                        MessageBox(NULL, pszFilePath, L<span class="stringliteral">&quot;File Path&quot;</span>, MB_OK);</div><div class="line">                        CoTaskMemFree(pszFilePath);</div><div class="line">                    }</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="comment">// pItem goes out of scope.</span></div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">// pFileOpen goes out of scope.</span></div><div class="line">        }</div><div class="line">        CoUninitialize();</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">} </div></div><!-- fragment --><h1><a class="anchor" id="equality_operator"></a>
Using == Operator Carefully</h1>
<p>Look at the following code fragment:</p>
<div class="fragment"><div class="line">CVehicle* pVehicle = GetCurrentVehicle();</div><div class="line"></div><div class="line"><span class="comment">// Validate pointer</span></div><div class="line"><span class="keywordflow">if</span>(pVehicle==NULL) <span class="comment">// Using == operator to compare pointer with NULL</span></div><div class="line">   <span class="keywordflow">return</span> FALSE; </div><div class="line"></div><div class="line"><span class="comment">// Do something with the pointer</span></div><div class="line">pVehicle-&gt;Run();</div></div><!-- fragment --><p>The code above is correct and uses pointer validation. But, assume you made a mistyping and used an assignment operator (=) instead of equality operator (==):</p>
<div class="fragment"><div class="line">CVehicle* pVehicle = GetCurrentVehicle();</div><div class="line"></div><div class="line"><span class="comment">// Validate pointer</span></div><div class="line"><span class="keywordflow">if</span>(pVehicle=NULL) <span class="comment">// Oop! A mistyping here!</span></div><div class="line">   <span class="keywordflow">return</span> FALSE; </div><div class="line"></div><div class="line"><span class="comment">// Do something with the pointer</span></div><div class="line">pVehicle-&gt;Run(); <span class="comment">// Crash!!! </span></div></div><!-- fragment --><p>As you can see from the code above, such mistyping may be the result of a stupid crash.</p>
<p>Such error can be avoided by slightly modifying the pointer validation code (exchange left side and right side of the equality operator). If you mistype in such modifyed code, such mistyping will be detected on compilation stage.</p>
<div class="fragment"><div class="line"><span class="comment">// Validate pointer</span></div><div class="line"><span class="keywordflow">if</span>(NULL==pVehicle) <span class="comment">// Exchange left side and right side of the equality operator</span></div><div class="line">   <span class="keywordflow">return</span> FALSE; </div><div class="line"></div><div class="line"><span class="comment">// Validate pointer</span></div><div class="line"><span class="keywordflow">if</span>(NULL=pVehicle) <span class="comment">// Oop! A mistyping here! But the compiler returns an error message.</span></div><div class="line">   <span class="keywordflow">return</span> FALSE; </div></div><!-- fragment --> </div></div><!-- contents -->
<hr size="1"><address style="text-align: right;"><small>
Generated on Fri Apr 21 2017 15:24:31 for CrashRpt by&nbsp;<a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.8.13</small></address>
</body>
</html>
