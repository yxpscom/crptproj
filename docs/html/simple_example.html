<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>An Example of Using CrashRpt API</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="style.css" rel="stylesheet" type="text/css">
<link rel="icon" href="../favicon.ico" type="image/x-icon" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<link href="$relpath/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="$relpath/search.js"></script>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<div style="padding:10px">
<table border="0" bgcolor="#FFFFFF" cellspacing="5" width="100%">
 <tr>
  <td width="24px" rowspan="2"><img src="../logo.png" alt="Logo" /></td>
  <td><font family="Arial" size="+2">crashrpt</font></td>
  <td rowspan="2" align="right"></td>
 </tr>
 <tr>
  <td colspan="2"><span style="font-size:0.9em"><i>A crash reporting system for Windows applications</i></a></td>
 </tr>
</table>
</div>
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">CrashRpt Documentation</a></li><li class="navelem"><a class="el" href="using_crashrpt.html">Using CrashRpt in Your Project</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">An Example of Using CrashRpt API </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The following example shows how to use CrashRpt API functions and structures to enable crash reporting support in a console C++ application. We use console application for simplicity, but in general the application may be WinAPI/MFC/ATL/WTL based, as well. For additional information on CrashRpt API functions and structures, please refer to <a class="el" href="using_crashrpt_api.html">Using CrashRpt API</a>.</p>
<p>First create a console Win32 application and call it MyApp. Then configure the MyApp application as described in <a class="el" href="configuring_project.html">Configuring Your Project's Build Settings</a>.</p>
<p>Let's assume the case when MyApp application has two threads. The first thread, the application thread, will be the main one. The <b>main()</b> function will be executed in this thread and interaction with user will also be performed in this thread. The second thread, the worker thread, is typically used when some time-consuming computational work is to be done without blocking the application thread.</p>
<p>The MyApp application will create a log file that will be included in error report on crash. The log file is typically helpful when debugging a crash.</p>
<p>Let's create the code template.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;windows.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;tchar.h&gt;</span></div><div class="line"></div><div class="line">FILE* g_hLog = NULL; <span class="comment">// Global handle to the application log file</span></div><div class="line"></div><div class="line"><span class="comment">// The following function writes an entry to the log file</span></div><div class="line"><span class="keywordtype">void</span> log_write(LPCTSTR szFormat, ...)</div><div class="line">{</div><div class="line">  <span class="keywordflow">if</span> (g_hLog == NULL) </div><div class="line">    <span class="keywordflow">return</span>; <span class="comment">// Log file seems to be closed</span></div><div class="line"></div><div class="line">  va_list args;</div><div class="line">  va_start(args); </div><div class="line">  _vftprintf_s(g_hLog, szFormat, args);</div><div class="line">  fflush(g_hLog);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// Thread procedure</span></div><div class="line">DWORD WINAPI ThreadProc(LPVOID lpParam)</div><div class="line">{</div><div class="line">  log_write(_T(<span class="stringliteral">&quot;Entering the thread proc\n&quot;</span>));</div><div class="line"></div><div class="line">  <span class="comment">// Define the infinite loop where some processing will be done </span></div><div class="line">  <span class="keywordflow">for</span>(;;)</div><div class="line">  {</div><div class="line">    <span class="comment">// There is a hidden error somewhere inside of the loop...</span></div><div class="line">    <span class="keywordtype">int</span>* p = NULL;</div><div class="line">    *p = 13; <span class="comment">// This results in Access Violation</span></div><div class="line">  }    </div><div class="line">   </div><div class="line">  log_write(_T(<span class="stringliteral">&quot;Leaving the thread proc\n&quot;</span>));</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> _tmain(<span class="keywordtype">int</span> argc, _TCHAR* argv[])</div><div class="line">{</div><div class="line">  <span class="comment">// Open log file</span></div><div class="line">  errno_t err = _tfopen_s(&amp;g_hLog, _T(<span class="stringliteral">&quot;log.txt&quot;</span>), _T(<span class="stringliteral">&quot;wt&quot;</span>));</div><div class="line">  <span class="keywordflow">if</span>(err!=0 || g_hLog==NULL)</div><div class="line">  {</div><div class="line">    _tprintf_s(_T(<span class="stringliteral">&quot;Error opening log.txt\n&quot;</span>));</div><div class="line">    <span class="keywordflow">return</span> 1; <span class="comment">// Couldn&#39;t open log file</span></div><div class="line">  }</div><div class="line"></div><div class="line">  log_write(_T(<span class="stringliteral">&quot;Started successfully\n&quot;</span>));</div><div class="line"></div><div class="line">  <span class="comment">// Create the worker thread</span></div><div class="line">  HANDLE hWorkingThread = CreateThread(NULL, 0, </div><div class="line">           ThreadProc, (LPVOID)NULL, 0, NULL);</div><div class="line"></div><div class="line">  log_write(_T(<span class="stringliteral">&quot;Created working thread\n&quot;</span>));</div><div class="line"></div><div class="line">  <span class="comment">// There is a hidden error in the main() function</span></div><div class="line">  <span class="comment">// Call of _tprintf_s with NULL parameter</span></div><div class="line">  TCHAR* szFormatString = NULL;</div><div class="line">  _tprintf_s(szFormatString);</div><div class="line"></div><div class="line">  <span class="comment">// Wait until the worker thread is exited</span></div><div class="line">  WaitForSingleObject(hWorkingThread, INFINITE);</div><div class="line"></div><div class="line">  log_write(_T(<span class="stringliteral">&quot;Working thread has exited\n&quot;</span>));</div><div class="line"></div><div class="line">  <span class="comment">// Close the log file</span></div><div class="line">  <span class="keywordflow">if</span>(g_hLog!=NULL)</div><div class="line">  {</div><div class="line">    fclose(g_hLog);</div><div class="line">    g_hLog = NULL;<span class="comment">// Clean up handle</span></div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// Exit</span></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>We intentionally inserted the code that would cause an exception in both threads. In real-life programs such a code always exists, even when you test your application very carefully.</p>
<p>To enable crash reporting support in the application, we need to include CrashRpt header in the beginning of the code:</p>
<div class="fragment"><div class="line"><span class="comment">// Include CrashRpt Header </span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_crash_rpt_8h.html">CrashRpt.h</a>&quot;</span></div></div><!-- fragment --><p>Next, we define the crash callback function and call it <b>CrashCallback()</b>. The crash callback function will be called by CrashRpt when crash occurs, so we will be able to close the handle to log file. For more information on crash callback, see the the <a class="el" href="group___crash_rpt_structs.html#ga9b24a2fe5f56404484b6fd83b23b969b">PFNCRASHCALLBACK()</a> prototype.</p>
<div class="fragment"><div class="line"><span class="comment">// Define the callback function that will be called on crash</span></div><div class="line"><span class="keywordtype">int</span> CALLBACK CrashCallback(<a class="code" href="struct_c_r___c_r_a_s_h___c_a_l_l_b_a_c_k___i_n_f_o_a.html">CR_CRASH_CALLBACK_INFO</a>* pInfo)</div><div class="line">{  </div><div class="line">  <span class="comment">// The application has crashed!</span></div><div class="line"></div><div class="line">  <span class="comment">// Close the log file here</span></div><div class="line">  <span class="comment">// to ensure CrashRpt is able to include it into error report</span></div><div class="line">  <span class="keywordflow">if</span>(g_hLog!=NULL)</div><div class="line">  {</div><div class="line">    fclose(g_hLog);</div><div class="line">    g_hLog = NULL;<span class="comment">// Clean up handle</span></div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// Return CR_CB_DODEFAULT to generate error report</span></div><div class="line">  <span class="keywordflow">return</span> <a class="code" href="_crash_rpt_8h.html#a4850f09865c04d425c1127b8c09166fb">CR_CB_DODEFAULT</a>;</div><div class="line">}</div></div><!-- fragment --><p>Because we have a multi-threaded application, we need to use some <a class="el" href="group___crash_rpt_a_p_i.html">CrashRpt Functions</a> to set exception handlers for the worker thread. In this example, we use the <a class="el" href="group___crash_rpt_a_p_i.html#ga6fe5cff31697f687b29dc73cd34d72b4">crInstallToCurrentThread2()</a> and <a class="el" href="group___crash_rpt_a_p_i.html#gaaf56dbee81338534d96ab23f694be43c">crUninstallFromCurrentThread()</a> functions to set exception handlers in the beginning of the thread procedure and unset them in the end of the thread procedure, respectively.</p>
<div class="fragment"><div class="line"><span class="comment">// Thread procedure</span></div><div class="line">DWORD WINAPI ThreadProc(LPVOID lpParam)</div><div class="line">{</div><div class="line">  <span class="comment">// Install exception handlers for this thread</span></div><div class="line">  <a class="code" href="group___crash_rpt_a_p_i.html#ga6fe5cff31697f687b29dc73cd34d72b4">crInstallToCurrentThread2</a>(0);</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">  <span class="comment">// Unset exception handlers before exiting the thread</span></div><div class="line">  <a class="code" href="group___crash_rpt_a_p_i.html#gaaf56dbee81338534d96ab23f694be43c">crUninstallFromCurrentThread</a>();    </div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}    </div></div><!-- fragment --><p>Next, in the beginning of the <b>main()</b> function, we initialize the CrashRpt library and install the exception handlers for the entire process with the help of <a class="el" href="group___crash_rpt_a_p_i.html#ga24acb589d629460590d85735e12b5337" title="Character set-independent mapping of crInstallW() and crInstallA() functions. ">crInstall()</a> function and pass configuration information to it through the <a class="el" href="group___crash_rpt_structs.html#ga61e78b3a8180a386e7a40ecf125e5c1d">CR_INSTALL_INFO</a> structure. If something goes wrong, we can check the last error message with the <a class="el" href="group___crash_rpt_a_p_i.html#ga062f47d5f7284d72793c60699c7caa33">crGetLastErrorMsg()</a> function.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> _tmain(<span class="keywordtype">int</span> argc, _TCHAR* argv[])</div><div class="line">{  </div><div class="line">  <span class="comment">// Define CrashRpt configuration parameters</span></div><div class="line">  <a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html">CR_INSTALL_INFO</a> info;  </div><div class="line">  memset(&amp;info, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html">CR_INSTALL_INFO</a>));  </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a505370cf716d75d7e2e6377eb3b22cf2">cb</a> = <span class="keyword">sizeof</span>(<a class="code" href="group___crash_rpt_structs.html#ga61e78b3a8180a386e7a40ecf125e5c1d">CR_INSTALL_INFO</a>);    </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a4c560350f95d7996ba5a6170b37a9958">pszAppName</a> = _T(<span class="stringliteral">&quot;MyApp&quot;</span>);  </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a922d22acfcd70157b79e2a342b61235a">pszAppVersion</a> = _T(<span class="stringliteral">&quot;1.0.0&quot;</span>);  </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#ae16b16efd4896dcb437a3ca61cdb2bf6">pszEmailSubject</a> = _T(<span class="stringliteral">&quot;MyApp 1.0.0 Error Report&quot;</span>);  </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a634e444d697a9f3480e84ac3db85175c">pszEmailTo</a> = _T(<span class="stringliteral">&quot;myapp_support@hotmail.com&quot;</span>);    </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a51d0f4b80941a8185530c0ca473ebe0c">pszUrl</a> = _T(<span class="stringliteral">&quot;http://myapp.com/tools/crashrpt.php&quot;</span>);  </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a411524074b21a3de9c3005989c35443b">uPriorities</a>[<a class="code" href="_crash_rpt_8h.html#a7cb7df55f0fa979d1d4f5899e64e81e1">CR_HTTP</a>] = 3;  <span class="comment">// First try send report over HTTP </span></div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a411524074b21a3de9c3005989c35443b">uPriorities</a>[<a class="code" href="_crash_rpt_8h.html#a8a9140d2d3fcc6c1903e6ebe4bb8843d">CR_SMTP</a>] = 2;  <span class="comment">// Second try send report over SMTP  </span></div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a411524074b21a3de9c3005989c35443b">uPriorities</a>[<a class="code" href="_crash_rpt_8h.html#a0874e8ec6bad8eee3121cd8044f2a5bb">CR_SMAPI</a>] = 1; <span class="comment">// Third try send report over Simple MAPI    </span></div><div class="line">  <span class="comment">// Install all available exception handlers</span></div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a2ca0180aea2957c6698cd7c63925d33e">dwFlags</a> |= <a class="code" href="_crash_rpt_8h.html#a7ca8f2bce377fc05441f10c235dd55e2">CR_INST_ALL_POSSIBLE_HANDLERS</a>;</div><div class="line">  <span class="comment">// Restart the app on crash </span></div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a2ca0180aea2957c6698cd7c63925d33e">dwFlags</a> |= <a class="code" href="_crash_rpt_8h.html#a92c65e94c4f6f1363644114be2c49f7a">CR_INST_APP_RESTART</a>; </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a2ca0180aea2957c6698cd7c63925d33e">dwFlags</a> |= <a class="code" href="_crash_rpt_8h.html#a1d2fdb48ae4bf477109baf07b29dd26a">CR_INST_SEND_QUEUED_REPORTS</a>; </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a5ee73cf06c84b4dd8c355bed89f1ba13">pszRestartCmdLine</a> = _T(<span class="stringliteral">&quot;/restart&quot;</span>);</div><div class="line">  <span class="comment">// Define the Privacy Policy URL </span></div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#ad962d0982e1adb190da6274291313294">pszPrivacyPolicyURL</a> = _T(<span class="stringliteral">&quot;http://myapp.com/privacypolicy.html&quot;</span>); </div><div class="line">  </div><div class="line">  <span class="comment">// Install crash reporting</span></div><div class="line">  <span class="keywordtype">int</span> nResult = <a class="code" href="group___crash_rpt_a_p_i.html#ga24acb589d629460590d85735e12b5337">crInstall</a>(&amp;info);    </div><div class="line">  <span class="keywordflow">if</span>(nResult!=0)  </div><div class="line">  {    </div><div class="line">    <span class="comment">// Something goes wrong. Get error message.</span></div><div class="line">    TCHAR szErrorMsg[512] = _T(<span class="stringliteral">&quot;&quot;</span>);        </div><div class="line">    <a class="code" href="group___crash_rpt_a_p_i.html#ga062f47d5f7284d72793c60699c7caa33">crGetLastErrorMsg</a>(szErrorMsg, 512);    </div><div class="line">    _tprintf_s(_T(<span class="stringliteral">&quot;%s\n&quot;</span>), szErrorMsg);    </div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">  } </div></div><!-- fragment --><p>Next, we want to set the crash callback function by calling <a class="el" href="group___crash_rpt_a_p_i.html#ga072c795c3a8477ec6f22b6b92144312e" title="Character set-independent mapping of crSetCrashCallbackW() and crSetCrashCallbackA() functions...">crSetCrashCallback()</a>.</p>
<div class="fragment"><div class="line"><span class="comment">// Set crash callback function</span></div><div class="line"><a class="code" href="group___crash_rpt_a_p_i.html#ga072c795c3a8477ec6f22b6b92144312e">crSetCrashCallback</a>(CrashCallback, NULL);</div></div><!-- fragment --><p>Next, we want to add our error log file to the crash report. We do this with the <a class="el" href="group___crash_rpt_a_p_i.html#ga382c00cf76818ba1a66eb89715a030ea" title="Character set-independent mapping of crAddFile2W() and crAddFile2A() functions. ">crAddFile2()</a> function.</p>
<div class="fragment"><div class="line"><span class="comment">// Add our log file to the error report</span></div><div class="line"><a class="code" href="group___crash_rpt_a_p_i.html#ga382c00cf76818ba1a66eb89715a030ea">crAddFile2</a>(_T(<span class="stringliteral">&quot;log.txt&quot;</span>), NULL, _T(<span class="stringliteral">&quot;Log File&quot;</span>), <a class="code" href="_crash_rpt_8h.html#ae365a56cd807acedceff109c06782bdc">CR_AF_MAKE_FILE_COPY</a>);    </div></div><!-- fragment --><p>When the app crashes, we can include the screen shot to the crash report. We do this with the <a class="el" href="group___crash_rpt_a_p_i.html#ga255c2086d4b4b22ebec30428a067419c" title="Adds a screenshot to the crash report. ">crAddScreenshot2()</a> function.</p>
<div class="fragment"><div class="line"><span class="comment">// We want the screenshot of the entire desktop is to be added on crash</span></div><div class="line"><a class="code" href="group___crash_rpt_a_p_i.html#ga255c2086d4b4b22ebec30428a067419c">crAddScreenshot2</a>(<a class="code" href="_crash_rpt_8h.html#a5d0f686c9cbb88bdc7425ab3b8bf7d1a">CR_AS_VIRTUAL_SCREEN</a>, 0);   </div></div><!-- fragment --><p>The following code adds a named property to the crash description XML file (see the <a class="el" href="group___crash_rpt_a_p_i.html#ga5bc9d5a06b3ef1bb62e61b109f890730" title="Character set-independent mapping of crAddPropertyW() and crAddPropertyA() functions. ">crAddProperty()</a> function). The property tells what graphics adapter is installed on end user's computer (for simplicity, it is hardcoded, but you usually determine adapter's model dynamically using Windows Management Instrumentation, shortly WMI).</p>
<div class="fragment"><div class="line"><span class="comment">// Add a named property that means what graphics adapter is</span></div><div class="line"><span class="comment">// installed on end user&#39;s machine</span></div><div class="line"><a class="code" href="group___crash_rpt_a_p_i.html#ga5bc9d5a06b3ef1bb62e61b109f890730">crAddProperty</a>(_T(<span class="stringliteral">&quot;VideoCard&quot;</span>), _T(<span class="stringliteral">&quot;nVidia GeForce 8600 GTS&quot;</span>));</div></div><!-- fragment --><p>In the end of the <b>main()</b> function, we uninitialize CrashRpt and unset the exception handlers using the <a class="el" href="group___crash_rpt_a_p_i.html#gab5ff3a104014a1e138878a1882822442" title="Uninitializes the CrashRpt library and unsinstalls exception handlers previously installed with crIns...">crUninstall()</a> function.</p>
<div class="fragment"><div class="line"><span class="comment">// Uninitialize CrashRpt before exiting the main function</span></div><div class="line"><a class="code" href="group___crash_rpt_a_p_i.html#gab5ff3a104014a1e138878a1882822442">crUninstall</a>();</div></div><!-- fragment --><p>Below we have it all in one piece of code:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;windows.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;tchar.h&gt;</span></div><div class="line"><span class="comment">// Include CrashRpt Header </span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_crash_rpt_8h.html">CrashRpt.h</a>&quot;</span></div><div class="line"></div><div class="line">FILE* g_hLog = NULL; <span class="comment">// Global handle to the application log file</span></div><div class="line"></div><div class="line"><span class="comment">// Define the callback function that will be called on crash</span></div><div class="line"><span class="keywordtype">int</span> CALLBACK CrashCallback(<a class="code" href="struct_c_r___c_r_a_s_h___c_a_l_l_b_a_c_k___i_n_f_o_a.html">CR_CRASH_CALLBACK_INFO</a>* pInfo)</div><div class="line">{  </div><div class="line">  <span class="comment">// The application has crashed!</span></div><div class="line"></div><div class="line">  <span class="comment">// Close the log file here</span></div><div class="line">  <span class="comment">// to ensure CrashRpt is able to include it into error report</span></div><div class="line">  <span class="keywordflow">if</span>(g_hLog!=NULL)</div><div class="line">  {</div><div class="line">    fclose(g_hLog);</div><div class="line">    g_hLog = NULL;<span class="comment">// Clean up handle</span></div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// Return CR_CB_DODEFAULT to generate error report</span></div><div class="line">  <span class="keywordflow">return</span> <a class="code" href="_crash_rpt_8h.html#a4850f09865c04d425c1127b8c09166fb">CR_CB_DODEFAULT</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// The following function writes an entry to the log file</span></div><div class="line"><span class="keywordtype">void</span> log_write(LPCTSTR szFormat, ...)</div><div class="line">{</div><div class="line">  <span class="keywordflow">if</span> (g_hLog == NULL) </div><div class="line">    <span class="keywordflow">return</span>; <span class="comment">// Log file seems to be closed</span></div><div class="line"></div><div class="line">  va_list args; </div><div class="line">  va_start(args); </div><div class="line">  _vftprintf_s(g_hLog, szFormat, args);</div><div class="line">  fflush(g_hLog);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// Thread procedure</span></div><div class="line">DWORD WINAPI ThreadProc(LPVOID lpParam)</div><div class="line">{</div><div class="line">  <span class="comment">// Install exception handlers for this thread</span></div><div class="line">  <a class="code" href="group___crash_rpt_a_p_i.html#ga6fe5cff31697f687b29dc73cd34d72b4">crInstallToCurrentThread2</a>(0);</div><div class="line"></div><div class="line">  log_write(_T(<span class="stringliteral">&quot;Entering the thread proc\n&quot;</span>));</div><div class="line"></div><div class="line">  <span class="comment">// Define the infinite loop where some processing will be done </span></div><div class="line">  <span class="keywordflow">for</span>(;;)</div><div class="line">  {</div><div class="line">    <span class="comment">// There is a hidden error somewhere inside of the loop...</span></div><div class="line">    <span class="keywordtype">int</span>* p = NULL;</div><div class="line">    *p = 13; <span class="comment">// This results in Access Violation</span></div><div class="line">  }    </div><div class="line">   </div><div class="line">  log_write(_T(<span class="stringliteral">&quot;Leaving the thread proc\n&quot;</span>));</div><div class="line"></div><div class="line">  <span class="comment">// Unset exception handlers before exiting the thread</span></div><div class="line">  <a class="code" href="group___crash_rpt_a_p_i.html#gaaf56dbee81338534d96ab23f694be43c">crUninstallFromCurrentThread</a>();    </div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> _tmain(<span class="keywordtype">int</span> argc, _TCHAR* argv[])</div><div class="line">{  </div><div class="line">  <span class="comment">// Define CrashRpt configuration parameters</span></div><div class="line">  <a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html">CR_INSTALL_INFO</a> info;  </div><div class="line">  memset(&amp;info, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html">CR_INSTALL_INFO</a>));  </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a505370cf716d75d7e2e6377eb3b22cf2">cb</a> = <span class="keyword">sizeof</span>(<a class="code" href="group___crash_rpt_structs.html#ga61e78b3a8180a386e7a40ecf125e5c1d">CR_INSTALL_INFO</a>);    </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a4c560350f95d7996ba5a6170b37a9958">pszAppName</a> = _T(<span class="stringliteral">&quot;MyApp&quot;</span>);  </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a922d22acfcd70157b79e2a342b61235a">pszAppVersion</a> = _T(<span class="stringliteral">&quot;1.0.0&quot;</span>);  </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#ae16b16efd4896dcb437a3ca61cdb2bf6">pszEmailSubject</a> = _T(<span class="stringliteral">&quot;MyApp 1.0.0 Error Report&quot;</span>);  </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a634e444d697a9f3480e84ac3db85175c">pszEmailTo</a> = _T(<span class="stringliteral">&quot;myapp_support@hotmail.com&quot;</span>);    </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a51d0f4b80941a8185530c0ca473ebe0c">pszUrl</a> = _T(<span class="stringliteral">&quot;http://myapp.com/tools/crashrpt.php&quot;</span>);  </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a411524074b21a3de9c3005989c35443b">uPriorities</a>[<a class="code" href="_crash_rpt_8h.html#a7cb7df55f0fa979d1d4f5899e64e81e1">CR_HTTP</a>] = 3;  <span class="comment">// First try send report over HTTP </span></div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a411524074b21a3de9c3005989c35443b">uPriorities</a>[<a class="code" href="_crash_rpt_8h.html#a8a9140d2d3fcc6c1903e6ebe4bb8843d">CR_SMTP</a>] = 2;  <span class="comment">// Second try send report over SMTP  </span></div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a411524074b21a3de9c3005989c35443b">uPriorities</a>[<a class="code" href="_crash_rpt_8h.html#a0874e8ec6bad8eee3121cd8044f2a5bb">CR_SMAPI</a>] = 1; <span class="comment">// Third try send report over Simple MAPI    </span></div><div class="line">  <span class="comment">// Install all available exception handlers</span></div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a2ca0180aea2957c6698cd7c63925d33e">dwFlags</a> |= <a class="code" href="_crash_rpt_8h.html#a7ca8f2bce377fc05441f10c235dd55e2">CR_INST_ALL_POSSIBLE_HANDLERS</a>;</div><div class="line">  <span class="comment">// Restart the app on crash </span></div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a2ca0180aea2957c6698cd7c63925d33e">dwFlags</a> |= <a class="code" href="_crash_rpt_8h.html#a92c65e94c4f6f1363644114be2c49f7a">CR_INST_APP_RESTART</a>; </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a2ca0180aea2957c6698cd7c63925d33e">dwFlags</a> |= <a class="code" href="_crash_rpt_8h.html#a1d2fdb48ae4bf477109baf07b29dd26a">CR_INST_SEND_QUEUED_REPORTS</a>; </div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a5ee73cf06c84b4dd8c355bed89f1ba13">pszRestartCmdLine</a> = _T(<span class="stringliteral">&quot;/restart&quot;</span>);</div><div class="line">  <span class="comment">// Define the Privacy Policy URL </span></div><div class="line">  info.<a class="code" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#ad962d0982e1adb190da6274291313294">pszPrivacyPolicyURL</a> = _T(<span class="stringliteral">&quot;http://myapp.com/privacypolicy.html&quot;</span>); </div><div class="line">  </div><div class="line">  <span class="comment">// Install crash reporting</span></div><div class="line">  <span class="keywordtype">int</span> nResult = <a class="code" href="group___crash_rpt_a_p_i.html#ga24acb589d629460590d85735e12b5337">crInstall</a>(&amp;info);    </div><div class="line">  <span class="keywordflow">if</span>(nResult!=0)  </div><div class="line">  {    </div><div class="line">    <span class="comment">// Something goes wrong. Get error message.</span></div><div class="line">    TCHAR szErrorMsg[512] = _T(<span class="stringliteral">&quot;&quot;</span>);        </div><div class="line">    <a class="code" href="group___crash_rpt_a_p_i.html#ga062f47d5f7284d72793c60699c7caa33">crGetLastErrorMsg</a>(szErrorMsg, 512);    </div><div class="line">    _tprintf_s(_T(<span class="stringliteral">&quot;%s\n&quot;</span>), szErrorMsg);    </div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">  } </div><div class="line"></div><div class="line">  <span class="comment">// Set crash callback function</span></div><div class="line">  <a class="code" href="group___crash_rpt_a_p_i.html#ga072c795c3a8477ec6f22b6b92144312e">crSetCrashCallback</a>(CrashCallback, NULL);</div><div class="line"></div><div class="line">  <span class="comment">// Add our log file to the error report</span></div><div class="line">  <a class="code" href="group___crash_rpt_a_p_i.html#ga382c00cf76818ba1a66eb89715a030ea">crAddFile2</a>(_T(<span class="stringliteral">&quot;log.txt&quot;</span>), NULL, _T(<span class="stringliteral">&quot;Log File&quot;</span>), <a class="code" href="_crash_rpt_8h.html#ae365a56cd807acedceff109c06782bdc">CR_AF_MAKE_FILE_COPY</a>);    </div><div class="line"></div><div class="line">  <span class="comment">// We want the screenshot of the entire desktop is to be added on crash</span></div><div class="line">  <a class="code" href="group___crash_rpt_a_p_i.html#ga255c2086d4b4b22ebec30428a067419c">crAddScreenshot2</a>(<a class="code" href="_crash_rpt_8h.html#a5d0f686c9cbb88bdc7425ab3b8bf7d1a">CR_AS_VIRTUAL_SCREEN</a>, 0);   </div><div class="line"></div><div class="line">  <span class="comment">// Add a named property that means what graphics adapter is</span></div><div class="line">  <span class="comment">// installed on user&#39;s machine</span></div><div class="line">  <a class="code" href="group___crash_rpt_a_p_i.html#ga5bc9d5a06b3ef1bb62e61b109f890730">crAddProperty</a>(_T(<span class="stringliteral">&quot;VideoCard&quot;</span>), _T(<span class="stringliteral">&quot;nVidia GeForce 8600 GTS&quot;</span>));</div><div class="line"></div><div class="line">  <span class="comment">// The main code follows...</span></div><div class="line"></div><div class="line">  <span class="comment">// Open log file</span></div><div class="line">  errno_t err = _tfopen_s(&amp;g_hLog, _T(<span class="stringliteral">&quot;log.txt&quot;</span>), _T(<span class="stringliteral">&quot;wt&quot;</span>));</div><div class="line">  <span class="keywordflow">if</span>(err!=0 || g_hLog==NULL)</div><div class="line">  {</div><div class="line">    _tprintf_s(_T(<span class="stringliteral">&quot;Error opening log.txt\n&quot;</span>));</div><div class="line">    <span class="keywordflow">return</span> 1; <span class="comment">// Couldn&#39;t open log file</span></div><div class="line">  }</div><div class="line"></div><div class="line">  log_write(_T(<span class="stringliteral">&quot;Started successfully\n&quot;</span>));</div><div class="line"></div><div class="line">  <span class="comment">// Create the worker thread</span></div><div class="line">  HANDLE hWorkingThread = CreateThread(NULL, 0, </div><div class="line">           ThreadProc, (LPVOID)NULL, 0, NULL);</div><div class="line"></div><div class="line">  log_write(_T(<span class="stringliteral">&quot;Created working thread\n&quot;</span>));</div><div class="line"></div><div class="line">  <span class="comment">// There is a hidden error in the main() function</span></div><div class="line">  <span class="comment">// Call of _tprintf_s with NULL parameter</span></div><div class="line">  TCHAR* szFormatString = NULL;</div><div class="line">  _tprintf_s(szFormatString);</div><div class="line"></div><div class="line">  <span class="comment">// Wait until the worker thread is exited</span></div><div class="line">  WaitForSingleObject(hWorkingThread, INFINITE);</div><div class="line"></div><div class="line">  log_write(_T(<span class="stringliteral">&quot;Working thread has exited\n&quot;</span>));</div><div class="line"></div><div class="line">  <span class="comment">// Close the log file</span></div><div class="line">  <span class="keywordflow">if</span>(g_hLog!=NULL)</div><div class="line">  {</div><div class="line">    fclose(g_hLog);</div><div class="line">    g_hLog = NULL;<span class="comment">// Clean up handle</span></div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// Uninitialize CrashRpt before exiting the main function</span></div><div class="line">  <a class="code" href="group___crash_rpt_a_p_i.html#gab5ff3a104014a1e138878a1882822442">crUninstall</a>();</div><div class="line"></div><div class="line">  <span class="comment">// Exit</span></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>Do not forget to add <b>CrashRptXXXX.lib</b> file to the list of input libraries of your project (XXXX is the placeholder for the version of CrashRpt). For additional info, see <a class="el" href="configuring_project.html">Configuring Your Project's Build Settings</a>.</p>
<p>Before running the application, you should place the following files to the directory where your application executable file is located (for additional information, see <a class="el" href="preparing_to_software_release.html">Preparing to Software Release</a>):</p>
<ul>
<li><b>CrashRptXXXX.dll</b> (here and below XXXX should be replaced with the actual version of CrashRpt)</li>
<li><b>CrashSenderXXXX.exe</b> </li>
<li><b>dbghelp.dll</b> </li>
<li><b>crashrpt_lang.ini</b> </li>
</ul>
<p>When files have been copied, run the application. As error occurs, you should be able to see an error report window (for additional information, see <a class="el" href="error_report.html">About an Error Report</a>)</p>
<p><em>Further reading:</em> <a class="el" href="internationalization_support.html">Internationalization Support</a>. </p>
</div></div><!-- contents -->
<hr size="1"><address style="text-align: right;"><small>
Generated on Fri Apr 21 2017 15:24:31 for CrashRpt by&nbsp;<a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.8.13</small></address>
</body>
</html>
