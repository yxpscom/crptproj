<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Enabling Crash Reporting and Adding Files to Crash Report</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="style.css" rel="stylesheet" type="text/css">
<link rel="icon" href="../favicon.ico" type="image/x-icon" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<link href="$relpath/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="$relpath/search.js"></script>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<div style="padding:10px">
<table border="0" bgcolor="#FFFFFF" cellspacing="5" width="100%">
 <tr>
  <td width="24px" rowspan="2"><img src="../logo.png" alt="Logo" /></td>
  <td><font family="Arial" size="+2">crashrpt</font></td>
  <td rowspan="2" align="right"></td>
 </tr>
 <tr>
  <td colspan="2"><span style="font-size:0.9em"><i>A crash reporting system for Windows applications</i></a></td>
 </tr>
</table>
</div>
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">CrashRpt Documentation</a></li><li class="navelem"><a class="el" href="using_crashrpt.html">Using CrashRpt in Your Project</a></li><li class="navelem"><a class="el" href="using_crashrpt_api.html">Using CrashRpt API</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Enabling Crash Reporting and Adding Files to Crash Report </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This page describes how to initialize CrashRpt and how to add various files to crash report.</p>
<h1><a class="anchor" id="enabling"></a>
Enabling Crash Reporting</h1>
<p>To enable crash reporting support in your C++ application you use <a class="el" href="group___crash_rpt_a_p_i.html#ga24acb589d629460590d85735e12b5337" title="Character set-independent mapping of crInstallW() and crInstallA() functions. ">crInstall()</a> function. The function <a class="el" href="group___crash_rpt_a_p_i.html#ga24acb589d629460590d85735e12b5337" title="Character set-independent mapping of crInstallW() and crInstallA() functions. ">crInstall()</a> installs exception handlers that work for the entire process. Typically you call the <a class="el" href="group___crash_rpt_a_p_i.html#ga24acb589d629460590d85735e12b5337" title="Character set-independent mapping of crInstallW() and crInstallA() functions. ">crInstall()</a> in the beginning of your <b>main()</b> or <b>WinMain()</b> function.</p>
<p>You pass configuration settings to <a class="el" href="group___crash_rpt_a_p_i.html#ga24acb589d629460590d85735e12b5337" title="Character set-independent mapping of crInstallW() and crInstallA() functions. ">crInstall()</a> through the <a class="el" href="group___crash_rpt_structs.html#ga61e78b3a8180a386e7a40ecf125e5c1d">CR_INSTALL_INFO</a> structure. The configuration settings include application name and version, recipient's e-mail address or URL, path for saving error reports, Privacy Policy URL and so on.</p>
<p>On application exit, you use the <a class="el" href="group___crash_rpt_a_p_i.html#gab5ff3a104014a1e138878a1882822442" title="Uninitializes the CrashRpt library and unsinstalls exception handlers previously installed with crIns...">crUninstall()</a> function to unset exception handlers and uninitialize CrashRpt.</p>
<p><b>A note for MFC users.</b></p>
<p>If your application is MFC-based, you should override your <em>CWinApp::Run()</em> method and install CrashRpt there. In the CPP file containing your App class, add the following code:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> CMFCDemoApp::Run() </div><div class="line">{</div><div class="line">  <span class="comment">// Call your crInstall code here ...</span></div><div class="line"></div><div class="line">  BOOL bRun;</div><div class="line">  BOOL bExit=FALSE;</div><div class="line">  <span class="keywordflow">while</span>(!bExit)</div><div class="line">  {</div><div class="line">    bRun= CWinApp::Run();</div><div class="line">    bExit=TRUE;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// Uninstall CrashRpt here...</span></div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> bRun;</div><div class="line">}</div></div><!-- fragment --><p>It is also recommended to override the <em>CWinApp::ProcessWndProcException()</em> method as follows.</p>
<div class="fragment"><div class="line">LRESULT CMFCDemoApp::ProcessWndProcException(CException* e, <span class="keyword">const</span> MSG* pMsg)</div><div class="line">{</div><div class="line">  <span class="comment">// This is where we land with some MFC exceptions.</span></div><div class="line">  <span class="comment">// If we needed to show a message or something, we could do that here.</span></div><div class="line">  <span class="comment">// However, in most cases, we just want to cause MFC to throw the </span></div><div class="line">  <span class="comment">// exception out to CrashRpt.</span></div><div class="line"> </div><div class="line">  <span class="comment">// Make MFC throw (and not catch) this exception so that CrashRpt can catch it.</span></div><div class="line">  THROW_LAST();</div><div class="line"> </div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">  <span class="comment">//return CWinApp::ProcessWndProcException(e, pMsg);</span></div><div class="line">}</div></div><!-- fragment --><p>The method above is called by MFC when there is an unhandled MFC exception. With this override in place, the MFC exception eventually finds its way into the CrashRpt handlers and the crash report is generated.</p>
<h1><a class="anchor" id="thread_crash_handlers"></a>
Per-thread Installation</h1>
<p>Some of exception handlers work for entire process and others work for the caller thread only. Because of this reason, if your application is multi-threaded, you have to additionally install exception handlers in each worker thread.</p>
<p>The function <a class="el" href="group___crash_rpt_a_p_i.html#ga6fe5cff31697f687b29dc73cd34d72b4" title="Installs exception handlers to the caller thread. ">crInstallToCurrentThread2()</a> installs exception handlers that work on per-thread basis. In a multi-threaded program you call the <a class="el" href="group___crash_rpt_a_p_i.html#ga6fe5cff31697f687b29dc73cd34d72b4" title="Installs exception handlers to the caller thread. ">crInstallToCurrentThread2()</a> for all threads except the main one. Typically you call this function in the beginning of the thread procedure.</p>
<p>Just before the return from the thread procedure, call the <a class="el" href="group___crash_rpt_a_p_i.html#gaaf56dbee81338534d96ab23f694be43c" title="Uninstalls C++ exception handlers from the current thread. ">crUninstallFromCurrentThread()</a> function to unset exception handlers from the caller thread. No need to call the <a class="el" href="group___crash_rpt_a_p_i.html#gaaf56dbee81338534d96ab23f694be43c" title="Uninstalls C++ exception handlers from the current thread. ">crUninstallFromCurrentThread()</a> function in the main execution thread, because <a class="el" href="group___crash_rpt_a_p_i.html#gab5ff3a104014a1e138878a1882822442" title="Uninitializes the CrashRpt library and unsinstalls exception handlers previously installed with crIns...">crUninstall()</a> will do that for you automatically.</p>
<p>The <a class="el" href="group___crash_rpt_a_p_i.html#ga6fe5cff31697f687b29dc73cd34d72b4" title="Installs exception handlers to the caller thread. ">crInstallToCurrentThread2()</a> and <a class="el" href="group___crash_rpt_a_p_i.html#gaaf56dbee81338534d96ab23f694be43c" title="Uninstalls C++ exception handlers from the current thread. ">crUninstallFromCurrentThread()</a> functions provide you with full control on when to install/uninstall thread exception handlers and which of them to install. But, sometimes it may be desired to install thread exception handlers automatically. For example, if you you need to catch exceptions in a thread created by a third-party module, but you don't have access to that module's source code.</p>
<p>Since v.1.4.2, you can ask CrashRpt to install the per-thread exception handlers automatically by specifying the <a class="el" href="_crash_rpt_8h.html#a55502c150f16cf575c03c75ef896bd87">CR_INST_AUTO_THREAD_HANDLERS</a> flags for <a class="el" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a2ca0180aea2957c6698cd7c63925d33e">CR_INSTALL_INFO::dwFlags</a> structure field. If this flag is specified, CrashRpt will install all available thread exception handlers in response on <b>DllMain()</b>'s reason codes <b>DLL_THREAD_ATTACH/DLL_THREAD_DETACH</b>. This flag has effect only when CrashRpt is compiled as a DLL (it does not work if CrashRpt is compiled as a static library).</p>
<dl class="section note"><dt>Note</dt><dd>If you are using <a class="el" href="_crash_rpt_8h.html#a55502c150f16cf575c03c75ef896bd87">CR_INST_AUTO_THREAD_HANDLERS</a> flag, you must not install per-thread exception handler manually with <a class="el" href="group___crash_rpt_a_p_i.html#ga6fe5cff31697f687b29dc73cd34d72b4" title="Installs exception handlers to the caller thread. ">crInstallToCurrentThread2()</a> function. These two methods are mutually exclusive and won't work together.</dd></dl>
<h1><a class="anchor" id="wrappers"></a>
Convenience Wrappers</h1>
<p>You can use <a class="el" href="group___crash_rpt_wrappers.html">CrashRpt Wrapper Classes</a> to simplify installation and uninstallation of exception handlers in your program.</p>
<p>Use <a class="el" href="class_cr_auto_install_helper.html" title="Installs exception handlers in constructor and uninstalls in destructor. ">CrAutoInstallHelper</a> wrapper class to install exception handlers in your <b>main()</b> function. In a multi-threaded program, use <a class="el" href="class_cr_thread_auto_install_helper.html" title="Installs (uninstalls) exception handlers for the caller thread in class&#39; constructor (destructor)...">CrThreadAutoInstallHelper</a> wrapper class to install exception handlers in each worker thread.</p>
<h1><a class="anchor" id="crash_callback"></a>
Notifying the Application on Crash</h1>
<p>Sometimes the client application should be notified on crash to be able to perform some actions. You can define a crash callback function (see <a class="el" href="group___crash_rpt_structs.html#ga9b24a2fe5f56404484b6fd83b23b969b" title="Character set-independent mapping of PFNCRASHCALLBACKW() and PFNCRASHCALLBACKA() function prototrypes...">PFNCRASHCALLBACK()</a> prototype) and pass its pointer to <a class="el" href="group___crash_rpt_a_p_i.html#ga072c795c3a8477ec6f22b6b92144312e" title="Character set-independent mapping of crSetCrashCallbackW() and crSetCrashCallbackA() functions...">crSetCrashCallback()</a> function. The specified crash callback function will be called on crash and information about the crash will be passed to the callback function through the <a class="el" href="group___crash_rpt_structs.html#ga1cf3f11e57ec0de854d65879d778dfac">CR_CRASH_CALLBACK_INFO</a> structure.</p>
<p>It is generally unsafe to do complex actions (e.g. memory allocation, heap operations) inside of this callback, because the application state may be unstable.</p>
<p>For example, the application may use this callback for closing handles to open log files that the application plans to include into the error report. Log files should be accessible for reading, otherwise CrashRpt won't be able to include them into error report.</p>
<p>Crash callback function can also be used to allow the client application to continue its execution after crash report generation. By default, CrashRpt terminates the client application after crash report generation, because the app may be in unstable state. But, if for some reason you need to continue client app's execution, you may do this by setting <a class="el" href="struct_c_r___c_r_a_s_h___c_a_l_l_b_a_c_k___i_n_f_o_a.html#a4f6c07d95d854df1ea859360247d9b15" title="Whether to terminate the process (the default) or to continue program execution. ">CR_CRASH_CALLBACK_INFO::bContinueExecution</a> structure field to <em>TRUE</em>.</p>
<h1><a class="anchor" id="testing_if_intercepted"></a>
Testing If Exceptions are Intercepted</h1>
<p>When you install crash reporting support to your program, it is important to test if CrashRpt intercepts exceptions properly. Use <a class="el" href="group___crash_rpt_a_p_i.html#ga71fc93e6828f68f88b80326104489720">crEmulateCrash()</a> function to emulate an exceptional situation. You may call this function in each thread of your program to ensure all exceptions will be caught.</p>
<h1><a class="anchor" id="adding_crashdump"></a>
Adding Crash Minidump File</h1>
<p>By default, CrashRpt generates crash minidump file on crash and includes it into the crash report. You can specify what minidump type to generate using <a class="el" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a9e09d512b1b4568028f0718dc3856ce2">CR_INSTALL_INFO::uMiniDumpType</a> structure member. The default minidump type is <b>MiniDumpNormal</b>. For the list of available minidump types, see the documentation for the <b>MiniDumpWriteDump()</b> function in MSDN.</p>
<p>The crash minidump file is generated with the Microsoft Debug Help library (<em>dbghelp.dll</em>). By default, CrashRpt searches for <em>dbghelp.dll</em> using the default search sequence (the directory where <em>CrashRpt.dll</em> is located, then system directory). Optionally, you may specify the path to <em>dbghelp.dll</em> using the <a class="el" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a5c040444cff1eba007b49213673638b1">CR_INSTALL_INFO::pszDebugHelpDLL</a> structure member.</p>
<p>It is also possible to disable crash minidump generation by specifying the <a class="el" href="_crash_rpt_8h.html#a282394262d0df5435570660d60a4f16c">CR_INST_NO_MINIDUMP</a> flag for <a class="el" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a2ca0180aea2957c6698cd7c63925d33e">CR_INSTALL_INFO::dwFlags</a> structure member.</p>
<h1><a class="anchor" id="adding_a_custom_file"></a>
Adding a Custom File</h1>
<p>Typically an application creates and maintains a log file where operations and errors are written. Such a log file can be helpful for crash analysis and should be added to your application's error report. You add application-specific files to the error report using <a class="el" href="group___crash_rpt_a_p_i.html#ga382c00cf76818ba1a66eb89715a030ea" title="Character set-independent mapping of crAddFile2W() and crAddFile2A() functions. ">crAddFile2()</a> function.</p>
<h1><a class="anchor" id="allow_delete"></a>
Allowing User to Attach or Delete Files</h1>
<p>Typically, application developer decides what files to add into error report. Hovewer, it may be needed to let an end user (or a quality assurance engineer) to attach new files to error report or remove existing files from error report.</p>
<p>To let user remove a file from error report, you have to pass the <a class="el" href="_crash_rpt_8h.html#afe119fa2f4f78548772d5eaae61e58de">CR_AF_ALLOW_DELETE</a> flag to <a class="el" href="group___crash_rpt_a_p_i.html#ga382c00cf76818ba1a66eb89715a030ea" title="Character set-independent mapping of crAddFile2W() and crAddFile2A() functions. ">crAddFile2()</a> function. When this flag is specified, user will be able to right-click the file in <em>Error Report Details</em> dialog and choose <em>Delete Selected File(s)</em> from the context menu to delete the file. Note that user is unable to delete standard files, such as <em>crashrpt.xml</em> or <em>crashdump.dmp</em>.</p>
<p>To let user attach more files to error report, specify the <a class="el" href="_crash_rpt_8h.html#acc403a22ca8e5d9739a05996030108f2">CR_INST_ALLOW_ATTACH_MORE_FILES</a> flag for <a class="el" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#a2ca0180aea2957c6698cd7c63925d33e">CR_INSTALL_INFO::dwFlags</a> structure member. When this is specified, the user will be able to right-click the list of files on <em>Error Report Details</em> dialog and choose <em>Attach More File(s)</em> item from the context menu. The <em>Open File</em> dialog appears in which user can select what files to attach.</p>
<h1><a class="anchor" id="adding_a_custom_property"></a>
Adding a Custom Property</h1>
<p>One way to add application-defined info to the error report is adding a file as described above. But sometimes you may want to extend the crash description XML file by adding a named literal property to the file. You can do this through the <a class="el" href="group___crash_rpt_a_p_i.html#ga5bc9d5a06b3ef1bb62e61b109f890730" title="Character set-independent mapping of crAddPropertyW() and crAddPropertyA() functions. ">crAddProperty()</a> function.</p>
<p>For example, you may need to add the info about the amount of free disk space on a specific disk drive at the moment of crash, or about the version of the graphics card driver.</p>
<h1><a class="anchor" id="adding_a_screenshot"></a>
Adding a Screen Shot</h1>
<p>Screen shots may help to see which button user clicked before the crash, to see the desktop state and easier reproduce the crash. You can make a screen shot of user's virtual screen or a screen shot of your main window using the <a class="el" href="group___crash_rpt_a_p_i.html#ga255c2086d4b4b22ebec30428a067419c" title="Adds a screenshot to the crash report. ">crAddScreenshot2()</a> function.</p>
<p>By enabling screenshot capture, you should be careful about user's privacy. Some parts of the desktop screenshot may contain private or user identifying information: folder names, wallpapers, photos, text fragments and so on. CrashRpt allows to fill some areas of the screen shot with black color to respect end user's privacy. For example, sometimes it may be enough to see only the region of the desktop occupied by your application and not the rest of desktop.</p>
<p>It is also recommended that you always provide a link to your Privacy Policy page describing what information you collect on crash and what purposes you use it for. By clicking the Send Report button, user confirms he/she is familiar with the contents of the error report and accepts the terms of the Privacy Policy.</p>
<h1><a class="anchor" id="adding_video"></a>
Adding a Video of a Crash</h1>
<p>As of v.1.4.0, CrashRpt is able to capture end user's desktop and record what happened just before crash to an .ogg video file and include the file to crash report. The recorded information may help the software vendor to better understand what actions the end user performed before client application crashed and reproduce the error.</p>
<p>To record the desktop state to a video file and add the file to crash report, use the <a class="el" href="group___crash_rpt_a_p_i.html#gaa49dfdd25095df316804ca0f934c5e15">crAddVideo()</a> function.</p>
<p>When the function is called, the notification dialog is displayed (see below). If the end user agrees to capture the screen and record the video, he/she clicks the 'Allow' button; otherwise he/she clicks the 'Cancel' button.</p>
<div class="image">
<img src="video_rec.png" alt="video_rec.png"/>
<div class="caption">
Video Recording Dialog</div></div>
<p> The <a href="http://en.wikipedia.org/wiki/Ogg">OGG</a> together with <a href="">Theora</a> are widely used video container and video codec, respectively, provided by the open-source OGG Project. OGG files can be opened and played in a browser like Google Chrome or Mozilla Firefox or in another video player understanding this format, like ffmpeg.</p>
<p>Although it is up to you (software vendor) to decide when to capture end user's screen, it is not recommended to do that always on your application's start up, because screen capture continuously consumes CPU resources and disk space. Instead, it is recommended to implement some GUI option (for example, a checkbox in your Application Settings dialog) allowing end user to enable this feature when necessary. An alternative way is to let your application automatically decide when to enable screen capture feature. For example, you app could enable screen capture if several crashes happen with it on end user's machine.</p>
<h1><a class="anchor" id="adding_a_reg_key"></a>
Adding a Registry Key</h1>
<p>Many applications store settings inside of Windows registry. Application's settings might be useful for crash analysis. You can ask CrashRpt to dump a registry key contents on crash. Use the <a class="el" href="group___crash_rpt_a_p_i.html#gae5c00c702ef3b674f9c4a509f61728e1">crAddRegKey()</a> function.</p>
<h1><a class="anchor" id="handling_errors"></a>
Handling Errors in CrashRpt Functions</h1>
<p>Typically, CrashRpt API functions return zero value if succeeded and non-zero if failed (refer to certain function's documentation for the meaning of function's return value). To get text error message of the last called function, use the <a class="el" href="group___crash_rpt_a_p_i.html#ga062f47d5f7284d72793c60699c7caa33" title="Defines character set-independent mapping for crGetLastErrorMsgW() and crGetLastErrorMsgA(). ">crGetLastErrorMsg()</a> function.</p>
<h1><a class="anchor" id="specifying_privacy_policy"></a>
Specifying the Privacy Policy File</h1>
<p>Crash information collected by CrashRpt may contain some user-identifying or private data (e.g. desktop screenshots and so on). That's why you should always provide a link to your Privacy Policy file describing what information you collect on crash and what purposes you use it for. By clicking the Send Report button, user confirms he/she is familiar with the contents of the error report and accepts the terms of the Privacy Policy.</p>
<p>To specify the file containing your Privacy Policy text, use the <a class="el" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#ad962d0982e1adb190da6274291313294">CR_INSTALL_INFO::pszPrivacyPolicyURL</a> structure member. This parameter can be either a web-based URL (e.g. <em><a href="http://example.com/privacy.html">http://example.com/privacy.html</a></em>), or an absolute path to local file (e.g. <em><a href="file:///C:/MyApp/privacy.html">file:///C:/MyApp/privacy.html</a></em>). The file may be an HTML page, a TXT file or an RTF file.</p>
<h1><a class="anchor" id="order_of_function_calls"></a>
The Order of Function Calls</h1>
<p>Typically, you call the functions described above in the following order:</p><ul>
<li>Initialize CrashRpt with <a class="el" href="group___crash_rpt_a_p_i.html#ga24acb589d629460590d85735e12b5337">crInstall()</a> function;</li>
<li>Add custom files, properties, desktop screenshots, video, registry keys to the error report;</li>
<li>Run the main application code or window message loop;</li>
<li>When the main application code exits, uninitialize CrashRpt with <a class="el" href="group___crash_rpt_a_p_i.html#gab5ff3a104014a1e138878a1882822442">crUninstall()</a>;</li>
<li>Exit the application.</li>
</ul>
<p>In general, you may add files, properties, desktop screenshots, video, registry keys any time after you call the <a class="el" href="group___crash_rpt_a_p_i.html#ga24acb589d629460590d85735e12b5337">crInstall()</a> function and before you call the <a class="el" href="group___crash_rpt_a_p_i.html#gab5ff3a104014a1e138878a1882822442">crUninstall()</a> function. It is also possible (but not recommended) to add those files inside of the crash callback function.</p>
<p>For a CrashRpt API usage example, please refer to <a class="el" href="simple_example.html">An Example of Using CrashRpt API</a> page.</p>
<p><em>Further reading:</em> <a class="el" href="sending_error_reports.html">Sending Error Reports</a>. </p>
</div></div><!-- contents -->
<hr size="1"><address style="text-align: right;"><small>
Generated on Fri Apr 21 2017 15:24:31 for CrashRpt by&nbsp;<a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.8.13</small></address>
</body>
</html>
